<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>飲食份量紀錄</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background-image 0.8s ease-in-out;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    h2 { margin-top: 20px; }
    .section {
      background: rgba(255, 255, 255, 0.85);
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
    }
    label input, label select {
      flex: 0 0 150px;
      margin-left: 10px;
    }
    .btn {
      margin-top: 10px;
      padding: 8px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #recordList {
      list-style: none;
      padding: 0;
    }
    #recordList li {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #ccc;
      font-size: 14px;
    }
    .negative {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>每日總份量設定</h2>
    <div class="section">
      <label>主食：<input type="number" id="totalMain" step="0.1"></label>
      <label>肉類：<input type="number" id="totalMeat" step="0.1"></label>
      <label>肉類（植物性蛋白）：<input type="number" id="totalPlant" step="0.1"></label>
      <label>蔬菜：<input type="number" id="totalVeg" step="0.1"></label>
      <label>蔬菜（水溶性纖維）：<input type="number" id="totalFiber" step="0.1"></label>
      <label>水果：<input type="number" id="totalFruit" step="0.1"></label>
      <label>B群：<input type="number" id="totalB" step="0.1"></label>
      <label>補充品名稱：<input type="text" id="suppName" placeholder="輸入名稱"></label>
      <label><span id="suppLabel">補充品</span>：<input type="number" id="totalSupp" step="0.1"></label>
      <button class="btn" onclick="saveSettings()">儲存設定</button>
    </div>

    <h2>輸入餐別與扣除份量</h2>
    <div class="section">
      <label>餐別：
        <select id="mealSelect">
          <option>早餐</option>
          <option>上午加餐</option>
          <option>午餐</option>
          <option>下午加餐</option>
          <option>晚餐</option>
          <option>宵夜</option>
        </select>
      </label>
      <label>主食：<input type="number" id="deductMain" step="0.1"></label>
      <label>肉類：<input type="number" id="deductMeat" step="0.1"></label>
      <label>肉類（植物性蛋白）：<input type="number" id="deductPlant" step="0.1"></label>
      <label>蔬菜：<input type="number" id="deductVeg" step="0.1"></label>
      <label>蔬菜（水溶性纖維）：<input type="number" id="deductFiber" step="0.1"></label>
      <label>水果：<input type="number" id="deductFruit" step="0.1"></label>
      <label>B群：<input type="number" id="deductB" step="0.1"></label>
      <label><span id="suppLabel2">補充品</span>：<input type="number" id="deductSupp" step="0.1"></label>
      <button class="btn" onclick="deductAll()">扣除並紀錄</button>
    </div>

    <h2>剩餘分量</h2>
    <div class="section" id="remainingSection"></div>

    <h2>紀錄列表</h2>
    <div class="section">
      <ul id="recordList"></ul>
    </div>

    <button class="btn" onclick="changeWallpaper()">更換桌布</button>
  </div>

<script>
  let totals = JSON.parse(localStorage.getItem("totals")) || {
    main: 0, meat: 0, plant: 0, veg: 0, fiber: 0, fruit: 0, b: 0, supp: 0, suppName: "補充品"
  };
  let remaining = JSON.parse(localStorage.getItem("remaining")) || { ...totals };
  let records = JSON.parse(sessionStorage.getItem("records")) || [];

  const wallpapers = [
    "https://images.pexels.com/photos/414171/pexels-photo-414171.jpeg",
    "https://images.pexels.com/photos/34950/pexels-photo.jpg",
    "https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg",
    "https://images.pexels.com/photos/1103970/pexels-photo-1103970.jpeg",
    "https://images.pexels.com/photos/417173/pexels-photo-417173.jpeg"
  ];

  function saveSettings() {
    totals = {
      main: parseFloat(document.getElementById("totalMain").value) || 0,
      meat: parseFloat(document.getElementById("totalMeat").value) || 0,
      plant: parseFloat(document.getElementById("totalPlant").value) || 0,
      veg: parseFloat(document.getElementById("totalVeg").value) || 0,
      fiber: parseFloat(document.getElementById("totalFiber").value) || 0,
      fruit: parseFloat(document.getElementById("totalFruit").value) || 0,
      b: parseFloat(document.getElementById("totalB").value) || 0,
      supp: parseFloat(document.getElementById("totalSupp").value) || 0,
      suppName: document.getElementById("suppName").value || "補充品"
    };
    remaining = { ...totals };
    localStorage.setItem("totals", JSON.stringify(totals));
    localStorage.setItem("remaining", JSON.stringify(remaining));
    document.getElementById("suppLabel").textContent = totals.suppName;
    document.getElementById("suppLabel2").textContent = totals.suppName;
    updateRemaining();
  }

  function deductAll() {
    let meal = document.getElementById("mealSelect").value;
    let deduct = {
      main: parseFloat(document.getElementById("deductMain").value) || 0,
      meat: parseFloat(document.getElementById("deductMeat").value) || 0,
      plant: parseFloat(document.getElementById("deductPlant").value) || 0,
      veg: parseFloat(document.getElementById("deductVeg").value) || 0,
      fiber: parseFloat(document.getElementById("deductFiber").value) || 0,
      fruit: parseFloat(document.getElementById("deductFruit").value) || 0,
      b: parseFloat(document.getElementById("deductB").value) || 0,
      supp: parseFloat(document.getElementById("deductSupp").value) || 0
    };

    for (let key in deduct) {
      remaining[key] = parseFloat((remaining[key] - deduct[key]).toFixed(1));
    }

    localStorage.setItem("remaining", JSON.stringify(remaining));

    let now = new Date();
    let time = now.toLocaleString("zh-TW");
    records.push({ meal, deduct, time });
    sessionStorage.setItem("records", JSON.stringify(records));

    updateRemaining();
    updateRecords();
  }

  function updateRemaining() {
    let section = document.getElementById("remainingSection");
    section.innerHTML = `
      主食：<span class="${remaining.main<0?'negative':''}">${remaining.main}</span><br>
      肉類：<span class="${remaining.meat<0?'negative':''}">${remaining.meat}</span><br>
      植物性蛋白：<span class="${remaining.plant<0?'negative':''}">${remaining.plant}</span><br>
      蔬菜：<span class="${remaining.veg<0?'negative':''}">${remaining.veg}</span><br>
      水溶性纖維：<span class="${remaining.fiber<0?'negative':''}">${remaining.fiber}</span><br>
      水果：<span class="${remaining.fruit<0?'negative':''}">${remaining.fruit}</span><br>
      B群：<span class="${remaining.b<0?'negative':''}">${remaining.b}</span><br>
      ${totals.suppName}：<span class="${remaining.supp<0?'negative':''}">${remaining.supp}</span>
    `;
  }

  function updateRecords() {
    let list = document.getElementById("recordList");
    list.innerHTML = "";
    records.forEach(r => {
      let li = document.createElement("li");
      li.textContent = `${r.time} 【${r.meal}】 主食:${r.deduct.main}, 肉類:${r.deduct.meat}, 植物蛋白:${r.deduct.plant}, 蔬菜:${r.deduct.veg}, 水溶纖維:${r.deduct.fiber}, 水果:${r.deduct.fruit}, B群:${r.deduct.b}, ${totals.suppName}:${r.deduct.supp}`;
      list.appendChild(li);
    });
  }

  function changeWallpaper() {
    const url = wallpapers[Math.floor(Math.random() * wallpapers.length)];
    document.body.style.backgroundImage = `url('${url}')`;
  }

  window.onload = () => {
    document.getElementById("suppLabel").textContent = totals.suppName;
    document.getElementById("suppLabel2").textContent = totals.suppName;
    updateRemaining();
    updateRecords();
    changeWallpaper();
  }
</script>
</body>
</html>
